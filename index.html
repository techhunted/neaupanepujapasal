<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Neaupane puja pasal - E-Billing System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --color-billing-bg: #f8fafc;
      --color-admin-bg: #f0f5f2;
      --color-invoice-bg: #fffbe7;
      --color-primary: #6c4f1e;
      --color-accent: #f5ba2a;
      --color-nav: #372711;
      --color-dashboard: #d1e8e2;
      --color-card: #fff;
      --color-sidebar: #ffc285;
      --color-error: #d32f2f;
      --color-success: #388e3c;
      --logo-size: 50px;
    }
    
    /* === FIX 1: Prevent horizontal scroll on body and HTML === */
    html, body {
        width: 100%;
        overflow-x: hidden; 
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--color-billing-bg);
      color: #222;
      padding-top: 75px; 
    }
    
    /* === TOPNAV - START === */
    .topnav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--color-nav);
      color: #fff;
      height: auto;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 9999;
      box-shadow: 0 1px 6px rgba(60,40,20,0.08);
    }
    .topnav .logo img {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      margin-right: 14px;
      background: #fffbe7;
    }
    .topnav .shop-text {
      flex: 1; 
      display: flex;
      flex-direction: column;
      line-height: 1.2em;
    }
    .topnav .shop-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #fff;
    }
    .topnav .shop-address {
      font-size: 0.9rem;
      color: #ffeab6;
    }
    .topnav .logout-btn {
      background: var(--color-accent);
      color: var(--color-nav);
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0; 
    }
    /* === TOPNAV - END === */

    .site-container {
      display: flex;
      height: calc(100vh - 75px); 
      /* FIX 2: Ensure container respects parent width */
      width: 100%;
    }
    .sidebar {
      width: 200px;
      background: var(--color-sidebar);
      min-width: 150px;
      flex-shrink: 0;
      display: flex; flex-direction: column;
      box-shadow: 1px 0 7px rgba(60,40,20,0.04);
      transition: width 0.2s;
    }
    .sidebar .nav-main {
      flex: 1;
      display: flex; flex-direction: column; align-items: stretch; padding: 20px 0;
    }
    .sidebar .nav-item {
      padding: 13px 32px;
      font-size: 1.1rem; margin: 6px 0; border-radius: 4px 20px 20px 4px;
      cursor: pointer; background: none; border: none; outline: none; transition: background 0.2s;
      text-align: left;
      display: flex; align-items: center; gap: 14px;
    }
    .sidebar .nav-item.active, .sidebar .nav-item:hover {
      background: var(--color-accent); color: var(--color-nav); font-weight: 600;
    }

    .mainarea {
      flex: 1; padding: 0; min-width: 0;
      background: var(--color-billing-bg);
      display: flex; flex-direction: column;
      transition: background 0.2s;
      /* FIX 3: Prevent main content from pushing scroll */
      max-width: 100%; 
      overflow: hidden; 
    }
    .billing-area {
      display: flex; flex: 1;
      background: var(--color-billing-bg);
      transition: background 0.2s;
    }

    /* Billing Section */
    .product-listing {
      flex: 1.1;
      background: #f9efe3;
      padding: 24px 10px 24px 24px;
      border-right: 2px solid #ffd392;
      overflow-y: auto;
      min-width: 320px;
      /* FIX 4: Ensure it doesn't break mainarea width */
      max-width: 100%;
    }
    .product-listing .product-search {
      display: flex; gap: 15px; margin-bottom: 20px;
    }
    .product-search input, .product-search select {
      padding: 7px 11px; border-radius: 5px; border: 1px solid #ecc173; outline: none;
      font-size: 1rem; min-width: 65px;
    }
    .product-table {
      width: 100%; border-spacing: 0; margin-top: 16px;
    }
    .product-table th { background: #fdcd81; color: #5b3c10; font-weight: 500; }
    .product-table td, .product-table th {
      padding: 8px 7px; border-bottom: 1px solid #ececec; font-size: 0.98em;
      text-align: left;
    }
    .product-table td .item-name-main { font-weight: 600; }
    .product-table td .item-size-sub { font-size: 0.8em; color: #777; display: block; }
    .add-btn {
      background: var(--color-primary); color: #fff; border: none; border-radius: 5px;
      padding: 5px 11px; cursor: pointer; font-weight: 600;
    }
    .add-btn:disabled { background: #ccc; color: #eee; cursor: not-allowed; }
    .cart {
      flex: 0.95;
      background: #fffce8; padding: 24px 24px 24px 10px;
      box-shadow: -1px 0 8px rgba(220,182,60,0.06) inset;
      display: flex; flex-direction: column; min-width: 290px;
      border-left: 1px solid #fee29b;
    }
    .cart-title { font-size: 1.18rem; font-weight: 600; margin-bottom: 17px; color: #a98325;}
    .cart-empty { text-align: center; margin: 40px 0; color: #aaa; }

    .cart-table {
      width: 100%; font-size: 0.99em; margin-bottom: 12px;
    }
    .cart-table td, .cart-table th {
      padding: 7px 4px;
      text-align: left;
    }
    .cart-table th { background: #fee7ac; color: #83610c;}
    .cart .inline-input {
      width: 44px; font-size: 1em; padding: 1px 6px; border-radius: 4px; border: 1px solid #f1dd95;
    }
    .cart-summary {
      margin: 13px 0 10px 0;
      font-size: 1.09em;
    }
    .cart-label {
      color: #7a6906; font-weight: 500; margin-right: 7px;
    }
    .cart .process-payment-btn {
      background: var(--color-accent); color: var(--color-nav);
      width: 100%; padding: 12px; margin-top: 11px; font-size: 1.04rem;
      border: none; border-radius: 8px; font-weight: bold;
      cursor: pointer; transition: background 0.18s;
      box-shadow: 0 2px 9px #f5cb44a0;
    }
    .cart .process-payment-btn:disabled {
      background: #edc474; color: #d9d0c0; cursor: not-allowed;
      opacity: 0.7;
    }

    /* Modal / Popup */
    .modal-bg {
      display: none; justify-content: center; align-items: center; position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(63,49,31,0.22);
      z-index: 1100;
    }
    .modal-bg.active { display: flex; }
    .modal-box {
      background: #fffdf4; border-radius: 15px; box-shadow: 0 0 33px #e8dbac88;
      min-width: 330px; max-width: 98vw; padding: 28px 29px; position: relative;
      animation: fadeInUp 0.27s;
    }
    @keyframes fadeInUp {
      0% { transform: translateY(48px) scale(0.96); opacity: 0.01;}
      85% { transform: translateY(-8px) scale(1.03);}
      100% { transform: none;}
    }
    .modal-box h3 { margin-top: 0; }
    .modal-close {
      position: absolute; top: 15px; right: 14px; font-size: 1.27em; cursor: pointer; color: #b0932f;
      border: none; background: none;
    }
    /* Payment modal fields */
    .modal-box label { display:block; margin-top: 9px; font-weight: 500; }
    .modal-box input, .modal-box select {
      padding: 7px 10px; margin-top: 3px; width: 97%; border-radius: 5px;
      font-size: 1.02em; border: 1px solid #e4d17e; outline: none;
    }
    .modal-box .summary-row {
      display: flex; justify-content: space-between; margin: 7px 0;
      font-size: 1.03em;
    }
    .gen-invoice-btn {
      margin-top: 21px; width: 100%; background: var(--color-accent); color: var(--color-nav);
      font-weight: bold; font-size: 1.12em; border: none; border-radius: 6px;
      padding: 11px; cursor: pointer; box-shadow: 0 3px 18px #ffdd77a8;
      transition: background 0.22s;
    }

    /* Invoice styles */
    .invoice-area {
      background: var(--color-invoice-bg); padding: 34px 2vw;
      display:none; flex-direction: column; align-items:center;
      min-height:70vh;
    }
    .invoice-box {
      min-width: 350px; max-width: 430px;
      background: #fffdfa;
      border-radius: 14px; padding: 23px 25px 15px 25px;
      box-shadow: 0 3px 24px #e9e4ab9a;
      margin: auto; margin-top: 32px;
      color: #3f3a1e;
      font-size: 1.05em;
      position: relative;
      font-family:'Segoe UI',sans-serif;
    }
    .invoice-qr { position: absolute; right:15px; top:27px; }
    .invoice-header {
      text-align: center; margin-bottom: 13px;
    }
    .invoice-shopname { font-size: 1.2rem; font-weight: bold; letter-spacing: 0.5px;}
    .invoice-address { color: #7c6e33;}
    .invoice-table { width: 100%; font-size:0.98em;}
    .invoice-table th, .invoice-table td { padding:6px 4px; border-bottom: 1px solid #f5efbe;}
    .invoice-summary { margin: 15px 0 0 0; }
    .invoice-total { font-weight: bold; font-size: 1.11em; }
    .invoice-actions {
      display: flex; gap: 13px; justify-content: center; margin:18px 0 2px 0;
    }
    .invoice-actions button {
      padding: 8px 14px; border-radius: 6px; border:none;
      font-size: 1.04em; font-weight: 600;
      background: var(--color-accent); color: var(--color-nav); cursor:pointer;
      box-shadow:0 2px 7px #faf088a5;
      transition: background 0.17s;
    }

    /* Admin Section */
    .admin-area {
      display: flex; flex:1; background: var(--color-admin-bg);
      padding-bottom: 10px;
    }
    .admin-nav { width: 220px; background: #ffffffb9; padding: 20px 12px 12px 12px;
      border-right: 1px solid #f7c85b; min-width: 140px; border-radius: 0 24px 24px 0;}
    .admin-nav .admin-tab {
      margin-bottom: 13px; display:flex; align-items:center; gap:11px;
      padding:10px 13px; font-size:1em; border-radius: 7px 20px 20px 7px;
      cursor:pointer;
      background:none; border:none; color: #5f471e;
      font-weight:500;
    }
    .admin-tab.active, .admin-tab:hover {
      background: var(--color-dashboard); color: var(--color-nav);
    }

    .admin-content { flex: 1; padding: 28px 17px;}
    /* Add-item/Add-category/form sections */
    .form-card {
      background: #fff; border-radius: 8px; box-shadow: 0 2px 9px #b9b6ad47;
      padding: 22px 18px; margin-bottom: 21px;
    }
    .form-card label, .form-card input, .form-card select, .form-card textarea {
      display: block; width: 97%; margin-top: 7px; padding:9px 9px;
      font-size: 1em; border-radius:5px; border:1px solid #d4cdad; margin-bottom: 10px;
    }
    .form-card button {
      background: var(--color-accent); color: var(--color-nav); font-weight:600;
      border:none; border-radius:5px; padding:9px 13px; font-size:1em; margin-top:9px;
      cursor:pointer;
    }
    .admin-list-table { width: 100%; border-spacing: 0; margin-top: 9px; }
    .admin-list-table th, .admin-list-table td {
      padding: 7px 3px; border-bottom: 1px solid #f3ecd6; font-size: 1em;
      text-align:left;
    }
    .admin-stats { display:flex; gap:22px; flex-wrap:wrap; margin-bottom:18px;}
    .admin-card {
      background: #fdf9e0; padding:16px 19px; border-radius:9px; min-width:120px;
      box-shadow: 0 1px 7px #ffe8a0a8; min-height: 60px; text-align: center;
      flex:1 1 110px;
    }
    .admin-card .card-title { color: #716605; font-size:1.05em;}
    .admin-card .card-value { font-size: 1.23rem; font-weight:bold; margin-top:5px;}
    /* History and Report */
    .invoice-history-table { width:100%; border-spacing:0;}
    .invoice-history-table th, .invoice-history-table td {
      padding: 8px 4px; border-bottom: 1px solid #f4e5ac; text-align:left;
    }
    .year-warning { color: var(--color-error); font-weight: bold; margin:12px 0;}
    /* Toast/snackbar */
    .toast {
      display:none; position:fixed; bottom:23px; left: 50%; transform: translateX(-50%);
      background: #3d2f11; color:#fff1ae; padding: 14px 35px; border-radius:21px;
      font-size:1.08em; font-weight:500; z-index: 4000;
      box-shadow: 0 3px 19px #be9b2690;
      animation: fadeInOut 3s;
    }
    @keyframes fadeInOut {
      0%{opacity:0;bottom:8px;}
      8%{opacity:1;bottom:23px;}
      91%{opacity:1;}
      97%{opacity:0;}
      100%{opacity:0;}
    }

    /* Loading spinner */
    .spinner { display:inline-block; width:25px; height:25px; border: 3.5px solid #f5bd24;
      border-right: 3.5px solid #fff; border-radius:50%; animation: spin 1s linear infinite;}
    @keyframes spin { 100%{transform:rotate(360deg);} }

    /* Auth/login styles */
    .login-screen {
      position: fixed; z-index: 70000;
      inset:0; background: #fff5e0; display:flex; align-items:center; justify-content:center;
      height: 100vh; width: 100vw;
    }
    .login-box {
      background: #fffbe5; border-radius: 15px; box-shadow: 0 2px 31px #e1c96295;
      padding: 36px 41px; min-width: 320px; text-align: center; display:flex; flex-direction:column;align-items:center;
    }
    .login-box img { height: 100px; margin-bottom:9px; }
    .login-box h2 { margin:14px 0 17px 0; font-size:1.35rem; color:var(--color-primary);}
    .login-box input, .login-box button {
      display:block; width: 100%; margin: 7px 0 15px 0; border-radius: 7px; font-size:1.08rem;
      padding: 10px; border: 1px solid #ecd56d;
    }
    .login-box button { background: var(--color-accent); color: #422f0c; font-weight: bold; cursor: pointer;}
    .login-error { color: var(--color-error); font-size: 1.1em; }

    /* Responsive Design - Table Wrapper for horizontal scrolling on small screens */
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      border-radius: 8px;
      margin-top: 10px;
    }

    /* Delete button */
    .delete-btn {
      background:#e84141;
      color:white;
      border:none;
      padding:6px 10px;
      border-radius:6px;
      cursor:pointer;
      font-size:0.9rem;
    }

    .delete-btn i {
      pointer-events: none;
    }

    /* Mobile responsive table for ADDED ITEMS/PRODUCTS */
    @media(max-width: 720px) {
      /* Added-Items-Table (Admin) */
      #added-items-table th,
      #added-items-table td {
        padding: 10px 6px;
        font-size: 0.82rem;
        white-space: nowrap; /* Keep content on one line */
      }
      /* Product-Listing-Table (Billing) */
      #product-table th,
      #product-table td {
        padding: 8px 5px;
        font-size: 0.88em;
      }
      .delete-btn, .add-btn {
        padding:4px 8px;
        font-size:0.8rem;
      }
    }
    /* Hide on very small devices */
    @media(max-width: 520px) {
      /* Hide Company + Category on very small devices */
      #added-items-table th:nth-child(2),
      #added-items-table td:nth-child(2),
      #added-items-table th:nth-child(3),
      #added-items-table td:nth-child(3) {
        display:none; 
      }
    }
    @media(max-width: 380px) {
      /* Hide Qty also */
      #added-items-table th:nth-child(4),
      #added-items-table td:nth-child(4) {
        display:none; 
      }
    }

    /* Main Responsive Breakpoints */
    @media (max-width: 850px) {
      .site-container {
        flex-direction: column;
        height: auto;
        /* FIX: Ensure mobile layout takes full width but doesn't push scroll */
        width: 100%;
      }
      /* Sidebar for Mobile: horizontal nav */
      .sidebar { 
        width: 100vw; 
        flex-direction: row; 
        align-items: stretch; 
        height: auto; 
        min-width: unset;
        box-shadow: 0 1px 7px rgba(60,40,20,0.04);
        padding: 5px 0;
      }
      .sidebar .nav-main { 
        flex-direction: row; 
        gap: 0;
        padding: 0 10px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .sidebar .nav-item { 
        flex-shrink: 0;
        padding: 6px 12px;
        margin: 4px;
        font-size: 0.95rem;
        white-space: nowrap;
        border-radius: 4px;
      }
      .sidebar .nav-item i {
        display: none;
      }
      .mainarea { 
        height:auto;
        padding: 0; 
        max-width: 100%;
        overflow: hidden; /* FIX: Prevent mainarea scroll */
      }
      .billing-area, .admin-area { 
        flex-direction: column;
      }
      .product-listing, .cart, .admin-nav, .admin-content { 
        width:auto; min-width:0;
        padding: 15px 15px 15px 15px; 
        max-width: 100%; /* FIX: Ensure content respects padding/width */
      }
      .product-listing {
        border-right: none;
        border-bottom: 2px solid #ffd392;
      }
      .cart {
        border-left: none;
        box-shadow: none;
      }
      .admin-nav {
        border-right: none;
        border-bottom: 1px solid #f7c85b;
        border-radius: 0;
      }
    }

    @media (max-width: 600px) {
      /* Extra padding for smaller mobile screens */
      body {
        padding-top: 85px; 
      }
      /* FIX: Ensure mobile body padding is sufficient */
      body > :not(.topnav) {
          padding-top: 0 !important; /* Ensure content starts right after fixed topnav */
      }
    }
    
    @media print {
      body * {visibility: hidden;}
      .invoice-area, .invoice-box, .invoice-area * {visibility: visible !important;}
      .invoice-area { position: absolute; left: 0; top: 0; width: 100vw;}
      .invoice-actions { display:none !important;}
      .sidebar, .topnav { display:none !important;}
    }
  </style>
</head>
<body>
  <div class="topnav">
    <div class="logo">
      <img id="shop-logo" src="neaupane-logo.png" alt="Logo"/>
    </div>
    <div class="shop-text">
      <div class="shop-name">Neaupane puja pasal</div>
      <div class="shop-address">Bagdhara Road, Kalimpong</div>
      <div class="shop-address">Mobile:+919641891846</div>

    </div>
    <button onclick="logout()" class="logout-btn">
      Logout
    </button>
  </div>

  <div id="login-screen" class="login-screen" style="display:none;">
    <div class="login-box">
      <img id="login-logo" src="neaupane-logo.png" alt="Logo"/>
      <h2>Admin Login</h2>
      <input id="login-email" type="email" placeholder="Email" autocomplete="username" />
      <input id="login-password" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="login-btn">Login</button>
      <div class="login-error" id="login-error"></div>
      
    </div>
  </div>

  <div class="site-container">
    <nav class="sidebar">
      <div class="nav-main">
        </div>
    </nav>
    <div class="mainarea">
      <div class="billing-area" id="billing-area" style="display:flex;">
        <div class="product-listing">
          <div class="product-search">
            <input id="product-search" type="text" placeholder="Search items..." />
            <select id="product-category"><option value="">All Categories</option></select>
          </div>
          <div class="table-responsive">
            <table class="product-table" id="product-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Company</th>
                  <th>Qty (Unit)</th>
                  <th>₹Price</th>
                  <th>Add</th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
          </div>
        </div>
        <div class="cart">
          <div class="cart-title"><i class="fa fa-shopping-cart"></i> Cart</div>
          <div class="table-responsive">
            <table class="cart-table" id="cart-table">
              <thead>
                <tr>
                  <th>Name</th><th>Qty</th><th>₹Price</th><th>Subtotal</th><th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="cart-subtotal" class="cart-summary"><span class="cart-label">Subtotal:</span> ₹0</div>
          <div style="margin-bottom:9px;">
            <span class="cart-label">Discount:</span>
            <input type="number" id="cart-discount" value="0" min="0" max="100" step="any" class="inline-input" style="width:50px;">
            <select id="discount-type" class="inline-input">
              <option value="percent">%</option>
              <option value="fixed">₹</option>
            </select>
          </div>
          <div class="cart-summary">
            <span class="cart-label">Total:</span> <span id="cart-total-amt">₹0</span>
          </div>
          <div style="margin:8px 0;">
            <span class="cart-label">Payment:</span>
            <select class="inline-input" id="payment-method">
              <option value="Cash">Cash</option>
              <option value="Card">Card</option>
              <option value="UPI">UPI</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <button class="process-payment-btn" id="process-payment-btn" disabled>Process Payment</button>
        </div>
      </div>
      <div class="invoice-area" id="invoice-area">
        <div class="invoice-box" id="invoice-box">
          </div>
        <div class="invoice-actions" id="invoice-actions">
          <button onclick="printInvoice()"><i class="fa fa-print"></i> Print</button>
          <button onclick="downloadInvoice()"><i class="fa fa-download"></i> Download</button>
          <button onclick="saveHoldInvoice()"><i class="fa fa-save"></i> Save/Hold</button>
        </div>
      </div>
      <div id="savedbills-area" style="display:none; padding: 20px;">
        <h2>Saved Bills</h2>
        <div class="table-responsive">
          <table class="admin-list-table" id="saved-bill-table"></table>
        </div>
      </div>
      <div class="admin-area" id="admin-area" style="display:none;">
        <nav class="admin-nav">
          <button class="admin-tab active" data-admin="todo-inv"><i class="fa fa-list-check"></i> To-do / Inventory</button>
          <button class="admin-tab" data-admin="totalsale"><i class="fa fa-chart-bar"></i> Total Sale</button>
          <button class="admin-tab" data-admin="history"><i class="fa fa-file-invoice"></i> History</button>
          <button class="admin-tab" data-admin="qrverify"><i class="fa fa-qrcode"></i> QR Code Verify</button>
          <button class="admin-tab" data-admin="addeditems">
          <i class="fa fa-box"></i> Added Items</button>
        </nav>
        <div class="admin-content" id="admin-content">
          </div>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="modal-bg">
    <div class="modal-box" id="modal-box">
      </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    // ==== Replace with your real Firebase config ====
    const firebaseConfig = {
      apiKey: "AIzaSyD_0pxd6FYZYAV00UcS-uTJZIly3d9YOr4",
      authDomain: "neaupanepujapasal-e0212.firebaseapp.com",
      databaseURL: "https://neaupanepujapasal-e0212-default-rtdb.firebaseio.com",
      projectId: "neaupanepujapasal-e0212",
      storageBucket: "neaupanepujapasal-e0212.firebasestorage.app",
      messagingSenderId: "1089550022144",
      appId: "1:1089550022144:web:ff11bd37b01f32cfa64ae5"
    };

    //==============

    // Firebase initialization
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // State
    let CATEGORIES = [];
    let ITEMS = [];
    let CART = [];
    let INVOICE = null;
    let productListenerUnsub = null;
    let userInit = false;

    // === CRITICAL: REPLACE THIS WITH YOUR REAL ADMIN EMAIL ===
    const REAL_ADMIN_EMAIL = "techhunted@gmail.com"; 
    // =========================================================

    // Auth / Admin
    let currentUser = null; 
    let adminName = "Admin";
    

    // MAIN INIT
    window.onload = function() {
      showLogin();
      initSidebar(); // Called here initially to set up handlers
      document.getElementById('login-btn').onclick = loginUser;
      document.getElementById('login-password').addEventListener('keypress', e=>{if(e.key==='Enter')loginUser();});
      document.getElementById('login-email').addEventListener('keypress', e=>{if(e.key==='Enter')loginUser();});
      document.getElementById('login-logo').src = document.getElementById('shop-logo').src; // Load logo on login screen
    };

    // ==== [LOGIN WORKFLOW] ====
    function showLogin(showErr = "") {
      document.getElementById('login-screen').style.display = 'flex';
      document.body.style.overflow = 'hidden';
      setTimeout(()=>{ document.getElementById('login-email').focus();},300);
      document.getElementById('login-error').innerText = showErr;
      // Hide in-app UI
      document.querySelector('.site-container').style.display = 'none';
      if (productListenerUnsub) { productListenerUnsub(); productListenerUnsub = null; }
    }
    function hideLogin() {
      document.getElementById('login-screen').style.display = 'none';
      document.body.style.overflow = '';
      document.querySelector('.site-container').style.display = 'flex';
    }
    
    function loginUser() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if (!email || !password) {
        document.getElementById('login-error').innerText = "Please enter email and password";
        return;
      }
      document.getElementById('login-btn').innerHTML = '<span class="spinner"></span>';
      
      auth.signInWithEmailAndPassword(email, password)
      .then(user=>{ 
        currentUser = user.user; // Set current user object
        adminName = email.split('@')[0]; 
        userInit = true; 
        initAll();
        initSidebar(); // Re-initialize sidebar to apply admin check
        hideLogin(); 
      })
      .catch(err=>{
        // Reset button on login failure
        document.getElementById('login-btn').innerText = "Login";
        document.getElementById('login-error').innerText = err.message || "Login failed. Check details.";
      });
    }
    
    // Optional log out on top right
    function logout() {
      if (window.confirm("Are you sure to logout?")) {
        // Reset the login button state before showing login screen
        document.getElementById('login-btn').innerText = "Login"; 
        document.getElementById('login-error').innerText = ""; 
        
        if(currentUser && currentUser.email == ADMIN_EMAIL) { // offline fallback (less relevant now)
          showLogin();
        } else {
          auth.signOut().then(showLogin);
        }
      }
    }
    // ==== [END LOGIN] ====

    // ==== [SIDEBAR NAV] ====
    function initSidebar() {
      const sidebar = document.querySelector('.sidebar .nav-main');
      
      // Clear any previous setup
      sidebar.innerHTML = '';
      
      // List of tabs
      const tabs = [
        { label: 'Billing', tab: 'billing', icon: 'fa-cash-register', isAdmin: false },
        { label: 'Saved Bills', tab: 'savedbills', icon: 'fa-file-invoice', isAdmin: false },
        { label: 'Admin', tab: 'admin', icon: 'fa-tools', isAdmin: true } // Identify Admin tab
      ];

      tabs.forEach((item, index) => {
        // Check karein ki user authenticated hai aur uska email REAL_ADMIN_EMAIL se match karta hai
        const isCurrentUserAdmin = currentUser && currentUser.email === REAL_ADMIN_EMAIL;
        
        // Agar tab admin-only hai aur current user admin nahi hai, toh ise chhupa dein
        if (item.isAdmin && !isCurrentUserAdmin) {
            return; // Skip this tab (don't create the button)
        }

        // Button Creation Logic
        const button = document.createElement('button');
        
        // Determine the class based on position or active state
        let activeClass = '';
        if (index === 0 && !document.querySelector('.sidebar .nav-item.active')) {
            activeClass = 'active'; // Set first visible tab as active if none is active
        } else {
             // Check if the current button is the 'billing' tab (default view)
             if (item.tab === 'billing') {
                activeClass = 'active'; 
             }
        }

        button.className = `nav-item ${activeClass}`;
        button.dataset.tab = item.tab;
        button.innerHTML = `<i class="fa ${item.icon}"></i> ${item.label}`;
        
        button.onclick = () => {
          // Deactivate all
          document.querySelectorAll('.sidebar .nav-item').forEach(n => n.classList.remove('active'));
          // Activate current
          button.classList.add('active');
          
          // Tab switching logic
          if (item.tab === "billing") {
            showBillingTab();
          }
          else if (item.tab === "savedbills") {
            showSavedBills();
          }
          else if (item.tab === "admin") {
            showAdminTab();
          }
        };
        
        sidebar.appendChild(button);
      });
      
      // Ensure the billing tab (or the first available tab) is selected on init
      if (document.querySelector('.sidebar .nav-item:not(.active)')) {
          document.querySelector('.sidebar .nav-item').click();
      }
    }

    // ==== [BILLING VIEW] ====
    function showBillingTab() {
      document.getElementById('billing-area').style.display = 'flex';
      document.getElementById('admin-area').style.display = 'none';
      document.getElementById('invoice-area').style.display = 'none';
      document.getElementById('savedbills-area').style.display = 'none'; 
      renderBilling();
    }
    
    // ==== [ADMIN VIEW] ====
    function showAdminTab() {
      document.getElementById('billing-area').style.display = 'none';
      document.getElementById('admin-area').style.display = 'flex';
      document.getElementById('invoice-area').style.display = 'none';
      document.getElementById('savedbills-area').style.display = 'none'; 
      renderAdminNav();
    }

    // ==== [APP DATA INIT] ====
    function initAll() {
      // Listen to products + categories
      listenCategories();
      listenProducts();
      // Misc UI binds
      document.getElementById('process-payment-btn').onclick = showPaymentModal;
      document.getElementById('cart-discount').oninput = updateCartTotals;
      document.getElementById('discount-type').onchange = updateCartTotals;
      document.getElementById('payment-method').onchange = e=>{ CART.paymentMethod=e.target.value;};
      document.getElementById('product-search').oninput = renderBillingProducts;
      document.getElementById('product-category').onchange = renderBillingProducts;
      if(!userInit) {window.addEventListener('beforeunload', ()=>{if(productListenerUnsub) productListenerUnsub();});}
      userInit = true;
    }

    // ==== [CATEGORIES & ITEM LOAD/LISTEN/RENDER] ====
    function listenCategories() {
      db.collection('categories').onSnapshot( snap => {
        CATEGORIES = snap.docs.map(doc=>({ id: doc.id, ...doc.data()}));
        renderCategoryDropdowns();
      }, err=> { seedDemoDataIfEmpty(err); });
    }
    function renderCategoryDropdowns() {
      // For Billing
      let catSel = document.getElementById('product-category');
      catSel.innerHTML = `<option value="">All Categories</option>`;
      CATEGORIES.forEach(cat=>{
        catSel.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
      });
      // For Admin Add Item
      const catd = document.getElementById('additem-category');
      if(catd) {
        catd.innerHTML = "";
        CATEGORIES.forEach(cat=>{
          catd.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
      }
    }
    function listenProducts() {
      if (productListenerUnsub) productListenerUnsub();
      productListenerUnsub = db.collection('products').onSnapshot( snap => {
        ITEMS = snap.docs.map(doc=>({ id: doc.id, ...doc.data()}));
        renderBillingProducts();
      }, err=> { seedDemoDataIfEmpty(err); });
    }
    function seedDemoDataIfEmpty(err) {
      if (err && err.code === 'not-found') {
        // No such collection: seed demo data
        let demoCats = [
          { name: "Puja Samagri" }, { name: "Books" }, { name: "Incense" }
        ];
        let demoItems = [
          { name:"Rudraksha mala", company:"Ananda", category:"Puja Samagri", quantity:12, price:250, available:true, sku:"MALA10", description:"Genuine rudraksha beads mala"},
          { name:"Hawan Samagri", company:"PUJAPR", category:"Puja Samagri", quantity:48, price:60, available:true, sku:"HSN02"},
          { name:"Hanuman Chalisa", company:"GG Publisher", category:"Books", quantity:32, price:35, available:true, sku:"BOOK1"},
          { name:"Dhoop sticks", company:"Agarbati", category:"Incense", quantity:90, price:22, available:true, sku:"INC03"}
        ];
        demoCats.forEach(cat=>db.collection('categories').add(cat));
        demoItems.forEach(itm=>db.collection('products').add(itm));
        showToast("Demo categories/items seeded.");
      }
    }

    // [Billing product listing]
   function renderBillingProducts() {
  let tbody = document.getElementById('product-table').querySelector('tbody');
  tbody.innerHTML = '';
  
  let search = (document.getElementById('product-search').value || '').toLowerCase();
  let cat = document.getElementById('product-category').value;
  
  ITEMS.filter(item => {
    let matchCat = !cat || item.category === cat;
    let matchSearch = !search || [item.name, item.company, item.sku, (item.description || "")].join(" ").toLowerCase().includes(search);
    return matchCat && matchSearch;
  }).forEach(item => {
    // === UPDATED: Unit aur Stock ko show karo ===
    let displayQty = item.stock || item.quantity || 0;  // Stock dikhao agar hai, nahi to quantity
    let unit = item.unit || 'pcs';  // Default unit
    
    tbody.innerHTML += `
      <tr>
        <td>
          <span class="item-name-main">${item.name}</span>
          ${item.size ? `<span class="item-size-sub">Size: ${item.size}</span>` : ''}
        </td>
        <td>${item.company}</td>
        <td>${displayQty} ${unit}</td>
        <td>₹${item.price}</td>
        <td>
          <input type="number" min="1" max="${displayQty}" value="1" id="qty-${item.id}" 
            style="width:37px;border: 1px solid #d1b97c; border-radius:4px;">
          <button class="add-btn" onclick="addToCart('${item.id}')"
            ${displayQty <= 0 || item.available === false ? 'disabled' : ''}>
            <i class="fa fa-plus"></i>
          </button>
        </td>
      </tr>
    `;
  });
}

    function addToCart(itemId) {
      let qty = Number(document.getElementById('qty-'+itemId).value)||1;
      let item = ITEMS.find(it=>it.id==itemId);
      // Ensure we clone the item including size for the cart
      let itemForCart = { ...item, qty: qty, size: item.size || '' }; 
      let inCart = CART.find(ci=>ci.id===item.id);
      
      if(inCart) { 
          inCart.qty+= qty; 
      }else{ 
          CART.push(itemForCart); 
      }
      updateCartTotals();
      renderCart();
    }
    function renderCart() {
      let tbody = document.getElementById('cart-table').querySelector('tbody'); tbody.innerHTML = "";
      if(!CART.length){tbody.innerHTML=`<tr><td colspan="5" class="cart-empty">Cart empty</td></tr>`;}
      CART.forEach((ci,i)=>{
        tbody.innerHTML += `
          <tr>
            <td>
              <span class="item-name-main">${ci.name}</span>
              ${ci.size ? `<span class="item-size-sub">${ci.size}</span>` : ''}
            </td>
            <td>
              <input type="number" class="inline-input" min="1" max="${ci.quantity}" value="${ci.qty}" onchange="cartQtyChange(${i},this.value)">
            </td>
            <td>₹${ci.price}</td>
            <td>₹${ci.qty*ci.price}</td>
            <td>
              <button class="add-btn" style="background:#ed5a5a;" onclick="removeCartItem(${i})"><i class="fa fa-trash"></i></button>
            </td>
          </tr>
        `;
      });
      updateCartTotals();
    }
    function cartQtyChange(idx, val) {
      let v = Number(val)||1;
      CART[idx].qty = v;
      renderCart();
    }
    function removeCartItem(idx) {
      CART.splice(idx,1); renderCart();
    }
    function updateCartTotals() {
      let subt = CART.reduce((s,ci)=>s+ci.price*ci.qty, 0);
      document.getElementById('cart-subtotal').innerHTML = `<span class="cart-label">Subtotal:</span> ₹${subt}`;
      let discount = parseFloat(document.getElementById('cart-discount').value) || 0;
      let dtype = document.getElementById('discount-type').value;
      let t = dtype==="percent"? subt*(1-discount/100) : Math.max(subtotal-discount,0);
      document.getElementById('cart-total-amt').innerText = "₹"+(t.toFixed(2));
      document.getElementById('process-payment-btn').disabled = !(CART.length>0);
      CART.paymentMethod = document.getElementById('payment-method').value;
    }

    // ==== [PAYMENT POPUP] ====
    function showPaymentModal() {
      updModal(`
        <h3>Process Payment</h3>
        <form id="pay-form" onsubmit="event.preventDefault(); createInvoice()">
          <label>Customer Name</label>
          <input required type="text" id="pay-custname" placeholder="Full name">
          <label>Phone Number</label>
          <input type="text" id="pay-custphone" placeholder="e.g. 98001234">
          <label>Payment Method</label>
          <select id="pay-method">
            <option>Cash</option><option>Card</option><option>UPI</option><option>Other</option>
          </select>
          <div class="summary-row"><span>Subtotal:</span> ₹${CART.reduce((s,ci)=>s+ci.price*ci.qty, 0)}</div>
          <div class="summary-row"><span>Discount:</span>
            <span>${document.getElementById('cart-discount').value}${document.getElementById('discount-type').value==="percent"?"%":"₹"}</span>
          </div>
          <div class="summary-row invoice-total">Grand Total: ₹<span id="modal-grand-total">...</span></div>
          <label>Pay Amount</label>
          <input type="number" id="pay-amt" placeholder="Amount Received">
          <div class="summary-row" id="modal-change-row"></div>
          <button class="gen-invoice-btn" type="submit">Generate Bill</button>
        </form>
      `, true);

      // Update grand total in realtime
      setTimeout(()=>{
        let discount = parseFloat(document.getElementById('cart-discount').value)||0;
        let subtotal = CART.reduce((s,ci)=>s+ci.price*ci.qty,0);
        let dtype = document.getElementById('discount-type').value;
        let total = dtype==="percent"? subtotal*(1-discount/100) : Math.max(subtotal-discount,0);
        document.getElementById('modal-grand-total').innerText = total.toFixed(2);
        document.getElementById('pay-amt').oninput = ()=>{
          let pay = Number(document.getElementById('pay-amt').value)||0, change=0;
          if(document.getElementById('pay-method').value==="Cash") {
            change = (pay-total)>0 ? (pay-total) : 0;
            document.getElementById('modal-change-row').innerHTML = `<span>Change Due:</span> ₹${change.toFixed(2)}`;
          }
        };
        document.getElementById('pay-method').value = CART.paymentMethod||"Cash";
      },70);
    }
    // Modal utils
    function updModal(html,show=true) {
      document.getElementById('modal-box').innerHTML = html + `<button class="modal-close" onclick="updModal('',false)">&times;</button>`;
      document.getElementById('modal-bg').classList.toggle('active',!!show);
    }
    window.onclick = function(e){ if(e.target.id==='modal-bg')updModal("",false);}
    // ==== [INVOICE GENERATION] ====
    function createInvoice() {
  // 1. Bill details customer se lo
  let cust = document.getElementById('pay-custname').value,
      phone = document.getElementById('pay-custphone').value;
  let subtotal = CART.reduce((s,ci)=>s+ci.price*ci.qty,0);
  let discount = parseFloat(document.getElementById('cart-discount').value)||0;
  let dtype = document.getElementById('discount-type').value;
  let total = dtype==="percent"? subtotal*(1-discount/100) : Math.max(subtotal-discount,0);
  let method = document.getElementById('pay-method').value;
  let payAmt = Number(document.getElementById('pay-amt').value)||0;
  let changeDue = (method==="Cash")?(payAmt-total):0;

  // 2. Invoice Object banao
  let iid = "INV"+Date.now();
  INVOICE = {
    id: iid,
    time: Date.now(),
    // Items data mein size bhi shamil kiya
    items: CART.map(c => ({ name: c.name, qty: c.qty, price: c.price, subtotal: c.qty * c.price, sku: c.sku, size: c.size || '' })),
    subtotal,
    discountType: dtype,
    discount,
    total: total,
    method,
    customer: cust,
    phone,
    payAmt,
    changeDue,
    adminName,
  };

  // 3. Invoice UI mein dikhana
  renderInvoice(INVOICE);
  showInvoice();
  updModal("", false);

  // === 4. MAIN ADDITIONS (SAVE, STOCK UPDATE, TOAST, HOLD) ===

  // 4a. Save invoice history mein (admin ke liye)
  db.collection('invoices').doc(INVOICE.id).set(INVOICE).then(() => {
    showToast("Invoice saved to history!");
    
    // --- 4b. Inventory (items) stock update karna ---
    INVOICE.items.forEach(ci => {
      db.collection('products').where('name', '==', ci.name).get().then(qs => {
        qs.forEach(doc => {
          let newQty = (doc.data().quantity || 0) - ci.qty;
          db.collection('products').doc(doc.id).update({ quantity: Math.max(newQty, 0) });
        });
      });
    });
  }).catch(err => {
    showToast("Invoice save failed! Try again.", "error");
  });

  // 4c. Bill Saved Bills tab ke liye bhi save karo
  db.collection('holdbills').doc(INVOICE.id).set(INVOICE).then(() => {
    showToast("Bill saved! Print/download anytime from Saved Bills tab.");
  }).catch(err => {
    showToast("Saved bills failed! Try again.", "error");
  });

  // 4d. UI: Optionally cart clear kar do
  CART = [];
  renderCart();
}

function showSavedBills() {
  document.getElementById('billing-area').style.display = 'none';
  document.getElementById('admin-area').style.display = 'none';
  document.getElementById('invoice-area').style.display = 'none';
  document.getElementById('savedbills-area').style.display = 'block';
  db.collection('holdbills').get().then(res=>{
    let tbl = document.getElementById('saved-bill-table');
    tbl.innerHTML = "<tr><th>Bill No</th><th>Customer</th><th>Total</th><th>Date</th><th>Action</th></tr>";
    res.forEach(doc=>{
      let d = doc.data();
      tbl.innerHTML += `<tr>
        <td>${d.id}</td>
        <td>${d.customer||"-"}</td>
        <td>₹${d.total}</td>
        <td>${new Date(d.time).toLocaleString()}</td>
        <td>
          <button class="add-btn" onclick="printSavedBill('${d.id}')">Print</button>
          <button class="add-btn" onclick="downloadSavedBill('${d.id}')">Download</button>
          <button class="delete-btn" onclick="deleteSavedBill('${d.id}')">Delete</button>
        </td>
      </tr>`;
    });
  });
}

async function printSavedBill(billid) {
  let doc = await db.collection('holdbills').doc(billid).get();
  if(doc.exists) {
    INVOICE = doc.data();
    renderInvoice(INVOICE);
    showInvoice();
    // After render, print
    setTimeout(()=>{
      window.print();
      // Optionally delete after printing (assuming print is successful)
      db.collection('holdbills').doc(billid).delete().then(()=>{
         showToast("Saved bill deleted after printing."); 
         showSavedBills();
      });
    }, 500); // Small delay for rendering
  }
}
function downloadSavedBill(billid) {
  // Download logic
  db.collection('holdbills').doc(billid).get().then(doc=>{
    if(doc.exists) {
      INVOICE = doc.data();
      renderInvoice(INVOICE); // Need to render to get the invoice-box content
      let area = document.getElementById('invoice-box');
      html2pdf().from(area).save(INVOICE.id+".pdf").then(()=>{
        db.collection('holdbills').doc(billid).delete().then(()=>{
          showToast("Saved bill deleted after download.");
          showSavedBills();
        });
      });
    }
  });
}
function deleteSavedBill(billid) {
  if(confirm("Delete this saved bill?")) {
    db.collection('holdbills').doc(billid).delete().then(showSavedBills);
  }
}



    function showInvoice() {
      document.getElementById('billing-area').style.display = 'none';
      document.getElementById('admin-area').style.display = 'none';
      document.getElementById('savedbills-area').style.display = 'none';
      document.getElementById('invoice-area').style.display = 'flex';
      document.getElementById('invoice-actions').style.display = 'flex';
    }
    
    // === UPDATED: SHOP MOBILE AND NO LOGO ===
    function renderInvoice(inv) {
      document.getElementById('invoice-box').innerHTML = `
        <div class="invoice-header">
          
          <div class="invoice-shopname">Neaupane puja pasal</div>
          <div class="invoice-address">Bagdhara Road, Kalimpong</div>
          
          <div class="invoice-address">Mobile: +919641891846</div>
          
          <div>Invoice: <b>${inv.id}</b></div>
          <div>Date: ${(new Date(inv.time)).toLocaleString()}</div>
        </div>
        <table class="invoice-table">
          <thead>
            <tr><th>Name</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr>
          </thead>
          <tbody>
            ${inv.items.map(it=>`<tr>
              <td>
                ${it.name}
                ${it.size ? `<span class="item-size-sub" style="display:block;font-size:0.9em;color:#7c6e33;">Size: ${it.size}</span>` : ''}
              </td>
              <td>${it.qty}</td>
              <td>₹${it.price}</td>
              <td>₹${it.subtotal}</td>
            </tr>`).join("")}
          </tbody>
        </table>
        <div class="invoice-summary">
          <div>Subtotal: ₹${inv.subtotal}</div>
          <div>Discount: ${inv.discountType==="percent"?inv.discount+"%":"₹"+inv.discount}</div>
          <div class="invoice-total">Grand Total: <b>₹${inv.total.toFixed(2)}</b></div>
          <div>Payment: ${inv.method}</div>
          
          <div>Customer: ${inv.customer} ${inv.phone?`(${inv.phone})`:""}</div>
          
          <div>Operator: ${inv.adminName}</div>
        </div>
        <div class="invoice-qr" id="invoice-qr"></div>
      `;
    document.getElementById('invoice-actions').innerHTML = `
      <button onclick="printInvoice()"><i class="fa fa-print"></i> Print</button>
      <button onclick="downloadInvoice()"><i class="fa fa-download"></i> Download</button>
      <button onclick="saveHoldInvoice()"><i class="fa fa-save"></i> Save/Hold</button>
      <button onclick="showBillingTab()">Back</button>
    `;

      let qrPayload = JSON.stringify({ id: inv.id, total: inv.total, date: inv.time });
      setTimeout(()=>new QRCode(document.getElementById("invoice-qr"),{ text:qrPayload, width:72,height:72 }),100);
    }
    // === END UPDATED: SHOP MOBILE AND NO LOGO ===


    function printInvoice() {
      window.print();
    }
    function downloadInvoice() {
      let area = document.getElementById('invoice-box');
      html2pdf().from(area).save(INVOICE.id+".pdf");
    }
    function saveHoldInvoice() {
      // Re-save/Update the current invoice on holdbills collection
      db.collection('holdbills').doc(INVOICE.id).set(INVOICE).then(() => {
          showToast("Bill saved/held successfully! Find it in Saved Bills.", "success");
          // Clear current cart and switch to billing view
          CART = [];
          renderCart();
          setTimeout(showBillingTab, 1000);
      }).catch(err => {
          showToast("Failed to save bill on hold.", "error");
      });
    }

    // ==== [BILLING and CART render cycle] ====
    function renderBilling() { renderBillingProducts(); renderCart(); }

    // ==== [ADMIN PANEL NAV] ====
    function renderAdminNav() {
      let tabs = document.querySelectorAll('.admin-nav .admin-tab');
      tabs.forEach(tab=>{
        tab.onclick = ()=>{
          tabs.forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          let v = tab.dataset.admin;
          if(v==="todo-inv") renderAdminTodoInv();
          if(v==="totalsale") renderAdminTotalSale();
          if(v==="history") renderAdminHistory();
          if(v==="qrverify") renderAdminQRVerify();
          if(v==="addeditems") renderAdminAddedItems();

        };
      });
      tabs[0].click(); // default first
    }

    // ==== [ADMIN: TO-DO / INVENTORY] ====
    
    // Helper function to read file content
    function readFileContent(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(file);
        });
    }
    
    // Main function to process uploaded documents (CSV/JSON)
    async function processUploadedItems() {
        const fileInput = document.getElementById('item-upload-file');
        const file = fileInput.files[0];

        if (!file) {
            return showToast("Please select a file to upload.", "error");
        }

        const fileName = file.name.toLowerCase();
        let itemsToAdd = [];

        try {
            const content = await readFileContent(file);

            if (fileName.endsWith('.json')) {
                // Handle JSON format
                itemsToAdd = JSON.parse(content);
                if (!Array.isArray(itemsToAdd)) {
                    itemsToAdd = [itemsToAdd]; // If single object, put it in an array
                }
            } else if (fileName.endsWith('.csv')) {
                // Handle CSV format (simple parsing)
                const rows = content.trim().split('\n');
                if (rows.length < 2) {
                    return showToast("CSV file is empty or has no headers.", "error");
                }
                const headers = rows[0].split(',').map(h => h.trim().toLowerCase());
                
                rows.slice(1).forEach(row => {
                    const values = row.split(',').map(v => v.trim());
                    if (values.length === headers.length) {
                        let item = {};
                        headers.forEach((header, i) => {
                            let key = header.replace(/\s+/g, '').toLowerCase();
                            let value = values[i];
                            // Basic type conversion
                            if (['quantity', 'stock', 'price'].includes(key)) {
                                value = Number(value) || 0;
                            }
                            item[key] = value;
                        });
                        // Map CSV headers to Firestore schema keys if necessary (e.g., 'itemname' to 'name')
                        item.name = item.name || item.itemname || ''; 
                        item.category = item.category || 'Uncategorized';
                        if (item.name) itemsToAdd.push(item);
                    }
                });
            } else {
                return showToast("Unsupported file format. Use CSV or JSON.", "error");
            }
            
            if (itemsToAdd.length === 0) {
                 return showToast("File was processed, but no valid items were found.", "error");
            }

            // Save items to Firestore
            let successCount = 0;
            let batch = db.batch();
            itemsToAdd.forEach(itemData => {
                // Minimal validation before batching
                if (itemData.name) {
                    batch.set(db.collection('products').doc(), {
                        name: itemData.name,
                        company: itemData.company || '',
                        category: itemData.category || 'Uncategorized',
                        quantity: itemData.quantity || 0,
                        unit: itemData.unit || 'pcs',
                        stock: itemData.stock || itemData.quantity || 0,
                        price: itemData.price || 0,
                        available: true, // Default to available
                        sku: itemData.sku || '',
                        description: itemData.description || '',
                        size: itemData.size || ''
                    });
                    successCount++;
                }
            });

            await batch.commit();
            showToast(`✔ ${successCount} items successfully added/updated from file!`, "success");
            fileInput.value = ''; // Clear file input
            renderBillingProducts(); // Refresh billing list
            
        } catch (error) {
            console.error("Bulk upload error:", error);
            showToast("Error processing file. Check format and console.", "error");
        }
    }


    function renderAdminTodoInv() {
  document.getElementById('admin-content').innerHTML = `
    <div class="form-card">
      <h4>Add Category</h4>
      <form onsubmit="event.preventDefault();addCategory()">
        <label>Category Name</label>
        <input required id="addcat-name" placeholder="Enter category">
        <button type="submit"><i class="fa fa-plus"></i> Add Category</button>
      </form>
    </div>
    
    <div class="form-card">
      <h4>Bulk Item Upload (CSV/JSON)</h4>
      <p style="font-size: 0.9em; color: #7a6906;">
          Upload a file containing multiple items. Headers must include: name, price. Optional: quantity, category, size.
      </p>
      <input type="file" id="item-upload-file" accept=".csv,.json" style="padding: 10px 0; border: none;"/>
      <button onclick="processUploadedItems()"><i class="fa fa-upload"></i> Upload Items</button>
    </div>
    <div class="form-card">
      <h4>Add Single Item</h4>
      <form onsubmit="event.preventDefault();addItem()">
        <label>Item Name</label>
        <input required id="additem-name" placeholder="Enter item name">
        <label>Company</label>
        <input id="additem-company" placeholder="Company">
        <label>Category</label>
        <select id="additem-category"></select>
        
        <label>Quantity</label>
        <div style="display:flex; gap:10px;">
          <input type="number" min="0" id="additem-qty" placeholder="Enter quantity" style="flex:1;">
          <select id="additem-unit" style="flex:0.8;">
            <option value="pieces">Pieces</option>
            <option value="items">Items</option>
            <option value="kg">Kg</option>
            <option value="liter">Liter</option>
            <option value="box">Box</option>
            <option value="pack">Pack</option>
            <option value="dozen">Dozen</option>
            <option value="gram">Gram</option>
            <option value="ml">ML</option>
          </select>
        </div>
        
        <label>Size (Optional)</label>
        <input type="text" id="additem-size" placeholder="e.g. Small, 10x12cm, 50g">
        
        <label>Stock (Available)</label>
        <input type="number" min="0" id="additem-stock" placeholder="Current stock">
        
        <label>Price (₹)</label>
        <input type="number" min="0" id="additem-price">
        <label><input type="checkbox" id="additem-avail" checked> Available</label>
        <label>SKU (optional)</label>
        <input id="additem-sku" placeholder="SKU">
        <label>Description (optional)</label>
        <textarea id="additem-desc" rows="2"></textarea>
        <button type="submit"><i class="fa fa-plus"></i> Add Item</button>
      </form>
    </div>
  `;
  renderCategoryDropdowns();
}
    function addCategory() {
  let name = document.getElementById('addcat-name').value.trim();
  if(!name)
    return showToast("Category name required!", "error");

  db.collection('categories')
    .add({ name })
    .then(() => {
      showToast("✔ Category added successfully!", "success");

      // Input clear
      document.getElementById('addcat-name').value = "";
    })
    .catch(() => {
      showToast("Failed to add category!", "error");
    });
}

   function addItem() {
  let itm = {
    name: document.getElementById('additem-name').value.trim(),
    company: document.getElementById('additem-company').value.trim(),
    category: document.getElementById('additem-category').value,
    quantity: Number(document.getElementById('additem-qty').value) || 0,
    unit: document.getElementById('additem-unit').value,
    stock: Number(document.getElementById('additem-stock').value) || 0,
    price: Number(document.getElementById('additem-price').value) || 0,
    available: document.getElementById('additem-avail').checked,
    sku: document.getElementById('additem-sku').value.trim(),
    description: document.getElementById('additem-desc').value.trim(),
    
    // NAYA FIELD: SIZE
    size: document.getElementById('additem-size').value.trim(), 
  };

  if (!itm.name)
    return showToast("Item name required!", "error");

  db.collection('products')
    .add(itm)
    .then(() => {

      showToast("✔ Item added successfully!", "success");

      // Clear all fields, including the new size field
      document.getElementById('additem-name').value = "";
      document.getElementById('additem-company').value = "";
      document.getElementById('additem-qty').value = 0;
      document.getElementById('additem-stock').value = 0;
      document.getElementById('additem-price').value = "";
      document.getElementById('additem-sku').value = "";
      document.getElementById('additem-desc').value = "";
      document.getElementById('additem-size').value = ""; // CLEAR SIZE
    })
    .catch(() => {
      showToast("Failed to add item!", "error");
    });
}

    // ==== [ADMIN: TOTAL SALE] ====
    async function renderAdminTotalSale() {
        db.collection('invoices').onSnapshot(snapshot=>{
    let sum=0, cnt=0;
    snapshot.forEach(doc=>{
      sum+= doc.data().total; cnt++;
    });
    document.getElementById('sale-day').innerHTML = sum;
    document.getElementById('sale-count').innerHTML = cnt;
  });
      // Aggregated: today/month/year
      const adminContent = document.getElementById('admin-content');
      adminContent.innerHTML = `
        <div class="admin-stats" id="admin-stats">
          <div class="admin-card"><div class="card-title">Day Sale</div><div class="card-value" id="sale-day">...</div></div>
          <div class="admin-card"><div class="card-title">Month Sale</div><div class="card-value" id="sale-month">...</div></div>
          <div class="admin-card"><div class="card-title">Year Sale</div><div class="card-value" id="sale-year">...</div></div>
        </div>
        `;
      let invs = await db.collection('invoices').get();
      let n = new Date();
      let year=n.getFullYear(), mon=n.getMonth(), day=n.getDate();
      let sumDay=0,sumMon=0,sumYr=0, cntD=0, cntM=0, cntY=0;
      invs.forEach(inv=>{
        let dt = new Date(inv.data().time);
        if(dt.getFullYear() == year) { sumYr += inv.data().total; cntY++; }
        if(dt.getFullYear()==year&&dt.getMonth()==mon) { sumMon += inv.data().total; cntM++;}
        if(dt.getFullYear()==year&&dt.getMonth()==mon&&dt.getDate()==day) { sumDay += inv.data().total; cntD++; }
      });
      document.getElementById('sale-day').innerHTML = `₹${sumDay} <br/><span style="font-size:0.84em;font-weight:400">(${cntD} bills)</span>`;
      document.getElementById('sale-month').innerHTML = `₹${sumMon} <br/><span style="font-size:0.84em;font-weight:400">(${cntM} bills)</span>`;
      document.getElementById('sale-year').innerHTML = `₹${sumYr} <br/><span style="font-size:0.84em;font-weight:400">(${cntY} bills)</span>`;
    }

    // ==== [ADMIN: HISTORY & REPORT] ====
    async function renderAdminHistory() {
      document.getElementById('admin-content').innerHTML = `
        <h4>Invoice History</h4>
        <div class="table-responsive">
          <table class="invoice-history-table" id="invoice-hist-table">
            <thead>
              <tr>
                <th>Invoice ID</th><th>Date</th><th>Customer</th><th>Total</th><th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
          <button class="add-btn" onclick="generateHistoryReport('day')">Generate Day Report</button>
          <button class="add-btn" onclick="generateHistoryReport('month')">Generate Month Report</button>
          <button class="add-btn" onclick="generateHistoryReport('year')">Generate Year Report</button>
        </div>
        <div class="year-warning" style="display:none" id="year-del-warn">
          Generating the YEAR report will permanently delete all invoice data from the server. Are you sure?
          <br/>
          <button onclick="confirmYearReportDelete()">Yes, Continue</button>
          <button onclick="cancelYearReportDelete()">Cancel</button>
        </div>
      `;
      let tbl = document.getElementById('invoice-hist-table').querySelector('tbody');
      let invs = await db.collection('invoices').orderBy('time','desc').get();
      invs.forEach(doc=>{
        let d = doc.data();
        tbl.innerHTML += `
          <tr>
            <td>${d.id}</td>
            <td>${new Date(d.time).toLocaleString()}</td>
            <td>${d.customer||"-"}</td>
            <td>₹${d.total}</td>
            <td>
              <button class="add-btn" onclick="viewInvoiceById('${d.id}')"><i class="fa fa-eye"></i></button>
              <button class="delete-btn" onclick="deleteInvoice('${d.id}')"><i class="fa fa-trash"></i></button>
            </td>
          </tr>
        `;
      });
    }
    // Show invoice on history view
    async function viewInvoiceById(invId) {
      let doc = await db.collection('invoices').doc(invId).get();
      if(doc.exists) {
        INVOICE = doc.data();
        renderInvoice(INVOICE);
        document.getElementById('invoice-area').style.display='flex';
        document.getElementById('admin-area').style.display='none';
        document.getElementById('billing-area').style.display='none';
      }
    }
    function deleteInvoice(invId) {
      if(confirm("Are you sure you want to delete this invoice? This cannot be undone.")) {
        db.collection('invoices').doc(invId).delete().then(()=>{ showToast("Invoice deleted.","success"); renderAdminHistory(); });
      }
    }

    // ===== HISTORY REPORT & DANGEROUS DELETE =====
    let doYearDeletePending = false;
    function generateHistoryReport(type) {
      if(type==="year") {
        document.getElementById('year-del-warn').style.display='block';
        doYearDeletePending = true;
      } else {
        downloadHistoryReport(type,false);
      }
    }
    function cancelYearReportDelete() { 
      document.getElementById('year-del-warn').style.display='none';
      doYearDeletePending = false;
    }
    async function confirmYearReportDelete() {
      document.getElementById('year-del-warn').style.display='none';
      doYearDeletePending = false;
      await downloadHistoryReport("year",true);
      // Cleanup: delete all invoices
      let invs = await db.collection('invoices').get();
      let batch = db.batch();
      invs.forEach(doc=>batch.delete(doc.ref));
      await batch.commit();
      showToast("All yearly invoices deleted after export!","success");
      renderAdminHistory();
    }
    async function downloadHistoryReport(type,delAfter) {
      // Get invoices, format as CSV
      let invs = await db.collection('invoices').get();
      let n = new Date();
      let year=n.getFullYear(), mon=n.getMonth(), day=n.getDate();
      let arr=[["Invoice ID","Date","Customer","Total"]];
      invs.forEach(doc=>{
        let d = doc.data(); let dt = new Date(d.time);
        if(type==="day" && !(dt.getDate()==day&&dt.getMonth()==mon&&dt.getFullYear()==year)) return;
        if(type==="month" && !(dt.getMonth()==mon&&dt.getFullYear()==year)) return;
        if(type==="year" && !(dt.getFullYear()==year)) return;
        arr.push([d.id,dt.toLocaleString(),d.customer||"-",d.total]);
      });
      // CSV
      let csv = arr.map(row=>row.join(",")).join("\n");
      let blob = new Blob([csv],{type:"text/csv"});
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url; a.download =`Report_${type}_${Date.now()}.csv`; a.click();
      URL.revokeObjectURL(url);
      showToast("Report downloaded "+(delAfter?"and records to be deleted":""));
    }

    // ==== [ADMIN: QR CODE VERIFY] ====
    function renderAdminQRVerify() {
      document.getElementById('admin-content').innerHTML = `
        <div class="form-card">
          <h4>QR Code Verify (Camera)</h4>
          <button class="add-btn" onclick="startQRScan()">Start Camera</button>
          <video id="qr-video" width="200" style="display:none;"></video>
        </div>
        <div class="form-card">
          <h4>QR Code Verify (Manual)</h4>
          <input id="qr-manual-input" placeholder="Paste payload or invoice ID">
          <button class="add-btn" onclick="verifyManualQR()">Verify</button>
        </div>
        <div id="qr-verify-result" style="margin-top:12px;"></div>
      `;
    }
    function startQRScan() {
      let video = document.getElementById('qr-video');
      let res = document.getElementById('qr-verify-result');
      navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
      .then(stream=>{
        video.style.display='block'; video.srcObject=stream;
        video.play();
        let scan = ()=> {
          if(video.readyState === video.HAVE_ENOUGH_DATA){
            let canvas=document.createElement('canvas');canvas.width=video.videoWidth;canvas.height=video.videoHeight;
            canvas.getContext('2d').drawImage(video,0,0);
            let img=canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
            let code=jsQR(img.data,canvas.width,canvas.height);
            if(code){
              video.pause();video.srcObject.getTracks()[0].stop();
              res.innerHTML =`QR code detected: <pre>${code.data}</pre>`;
              verifyQRPayload(code.data,res);
              return;
            }
          }
          requestAnimationFrame(scan);
        }
        scan();
      }).catch(e=>{ res.innerHTML = "Camera access failed: "+e; });
    }
    function verifyManualQR() {
      let val = document.getElementById('qr-manual-input').value;
      let res = document.getElementById('qr-verify-result');
      verifyQRPayload(val,res);
    }
    async function verifyQRPayload(payload,el) {
      let id = "";
      try { let o=JSON.parse(payload); id=o.id||o.invoiceId||""; }catch{ id=payload;}
      let doc = await db.collection('invoices').doc(id).get();
      if(doc.exists) {
        el.innerHTML += "<br>Invoice found:<br>"+JSON.stringify(doc.data(),null,2);
      } else {
        el.innerHTML += "<br>No invoice found for: "+id;
      }
    }

    // ==== [TOAST/SNACKBAR MSGS] ====
    function showToast(msg, type="info") {
      let t = document.getElementById('toast');
      t.innerText = msg; t.style.background = type==="success"? "#388e3c": (type==="error"?"#d32f2f":"#3d2f11");
      t.style.display = "block";
      setTimeout(()=>{ t.style.display="none"; }, 3200);
    }

    // Helper: Admin logout, on logo click
    document.getElementById('shop-logo').onclick = logout;
    
function renderAdminAddedItems() {
  document.getElementById('admin-content').innerHTML = `
    <h3 style="margin-bottom:10px;">Added Items</h3>
    <div class="table-responsive">
      <table class="admin-list-table" id="added-items-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Company</th>
            <th>Category</th>
            <th>Qty</th>
            <th>Unit</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Size</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  `;

  // Firebase fetch
  db.collection('products').get().then(snapshot => {
    let tbody = document.querySelector('#added-items-table tbody');
    tbody.innerHTML = "";

    snapshot.forEach(doc => {
      let d = doc.data();

      tbody.innerHTML += `
        <tr>
          <td>${d.name}</td>
          <td>${d.company || "-"}</td>
          <td>${d.category}</td>
          <td>${d.quantity}</td>
          <td>${d.unit || '-'}</td>
          <td>₹${d.price}</td>
          <td>${d.stock || 0}</td>
          <td>${d.size || '-'}</td>
          <td>
            <button class="delete-btn" onclick="deleteItem('${doc.id}')">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });
  });
}


function deleteItem(itemId) {
  if (!confirm("Delete this item permanently?")) return;

  db.collection('products').doc(itemId).delete()
    .then(() => {
      showToast("Item deleted!", "success");
      renderAdminAddedItems();
    })
    .catch(() => showToast("Error deleting item!", "error"));
}




  </script>
</body>

</html>

